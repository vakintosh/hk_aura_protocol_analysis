= Harman Kardon Aura Speaker Protocol Analysis

I have a Harman Kardon Aura Plus speaker and want to reverse-engineer the protocol it uses with its app (Bass, EQ, Volume) and control playback (Pause, Play, Set Volume) and integrate it into Home Assistant, eliminating the need for the app. The speaker connects via Wi-Fi, and the HK Remote app controls bass and EQ settings not available elsewhere.

NOTE: This is a personal project and should be used only for personal purposes.

== Initial attempts

Iâ€™ve captured the packets from the speaker (172.16.1.68), the iPhone with the app installed on it (172.16.1.69), and the Mac that was streaming the music (172.16.1.66) with `sudo ettercap -T -M arp:remote /172.16.1.66// /172.16.1.68// /172.16.1.69// -w packets.pcap` and analyzed the pcap file with WireShark.

Looking at any packets that might be immediately relevant, we get this:


----
Wed Jan 15 15:45:54 2025 [442538]
TCP  172.16.1.69:62528 --> 172.16.1.68:8080 | AP (202)
GET /description.xml HTTP/1.1.
Host: 172.16.1.68:8080.
Date: Wed, 15 Jan 2025 03:45:39 GMT.
Connection: Keep-Alive.
User-Agent: NFLC/2.2 UPnP/1.0 DLNADOC/1.50.
friendlyName.dlna.org: Access_NFLC/2.2.

Wed Jan 15 15:45:54 2025 [144199]
UDP  172.16.1.68:3911 --> 172.16.1.69:63631 |  (226)
HTTP/1.1 200 OK.
CACHE-CONTROL: max-age=1800.
EXT:.
LOCATION: http://172.16.1.68:8080/description.xml.
SERVER: KnOS/3.2 UPnP/1.0 DMP/3.5.
ST: upnp:rootdevice.
USN: uuid:abc123-def456-ghi789-jkl012-mno345678901::upnp:rootdevice.
----

=== Initial Handshake (OPTIONS Command)

Client (172.16.1.66) sends an OPTIONS request to the server (172.16.1.68) to query supported commands. +
Server (172.16.1.68) responds with `RTSP/1.0 200 OK`, listing supported commands: ANNOUNCE, SETUP, RECORD, etc.

----
Wed Jan 15 15:52:09 2025 [489609]
TCP  172.16.1.66:65374 --> 172.16.1.68:5000 | AP (114)
OPTIONS * RTSP/1.0.
CSeq: 0.
DACP-ID: 1234A56B7890D1E2.
Active-Remote: 9876543210.
User-Agent: AirPlay/775.3.1.

Wed Jan 15 15:52:09 2025 [508360]
TCP  172.16.1.68:5000 --> 172.16.1.66:65374 | AP (159)
RTSP/1.0 200 OK.
Public: ANNOUNCE, SETUP, RECORD, PAUSE, FLUSH, TEARDOWN, OPTIONS, GET_PARAMETER, SET_PARAMETER, POST, GET.
Server: AirTunes/190.9.
CSeq: 0.
.

Wed Jan 15 15:55:45 2025 [908698]
TCP  172.16.1.66:49340 --> 172.16.1.68:5000 | AP (114)
OPTIONS * RTSP/1.0.
CSeq: 1.
DACP-ID: 1234A56B7890D1E2.
Active-Remote: 9876543210.
User-Agent: AirPlay/775.3.1.
.

Wed Jan 15 15:55:45 2025 [926811]
TCP  172.16.1.68:5000 --> 172.16.1.66:49340 | AP (159)
RTSP/1.0 200 OK.
Public: ANNOUNCE, SETUP, RECORD, PAUSE, FLUSH, TEARDOWN, OPTIONS, GET_PARAMETER, SET_PARAMETER, POST, GET.
Server: AirTunes/190.9.
CSeq: 1.

----

=== Authorization (POST Command)

The client sends a POST request to `/auth-setup`, indicating authentication or key exchange. +
The server responds with a payload of length 1076 bytes, likely containing authentication data or session parameters.

----
Wed Jan 15 15:55:45 2025 [927432]
TCP  172.16.1.66:49340 --> 172.16.1.68:5000 | AP (214)
POST /auth-setup RTSP/1.0.
Content-Length: 33.
Content-Type: application/octet-stream.
CSeq: 2.
DACP-ID: 1234A56B7890D1E2.
Active-Remote: 9876543210.
User-Agent: AirPlay/775.3.1.

Wed Jan 15 15:55:47 2025 [57885]
TCP  172.16.1.68:5000 --> 172.16.1.66:49340 | AP (114)
RTSP/1.0 200 OK.
Content-Type: application/octet-stream.
Content-Length: 1076.
Server: AirTunes/190.9.
CSeq: 2.
.
----

=== Session Initialization (ANNOUNCE and SETUP Commands)

The client sends an ANNOUNCE request with an SDP (Session Description Protocol) payload:
[start=1]
* Specifies the codec (AppleLossless), sample rate (44100 Hz), and cryptographic keys (mfiaeskey, aesiv). +

The server acknowledges the ANNOUNCE request and confirms session setup via a SETUP command: +
[start=1]
* Specifies RTP/AVP/UDP as the transport and provides port numbers for data, control, and timing communication.

----
Wed Jan 15 15:55:47 2025 [62613]
TCP  172.16.1.66:49340 --> 172.16.1.68:5000 | AP (537)
ANNOUNCE rtsp://172.16.1.68/2009199015507279999 RTSP/1.0.
Content-Length: 333.
Content-Type: application/sdp.
CSeq: 3.
DACP-ID: 1234A56B7890D1E2.
Active-Remote: 9876543210.
User-Agent: AirPlay/775.3.1.
.
v=0.
o=AirTunes 2009199015507279999 0 IN IP4 172.16.1.66.
s=AirTunes.
i=Vakintosh...s MBPro.
c=IN IP4 172.16.1.66.
t=0 0.
m=audio 0 RTP/AVP 96.
a=rtpmap:96 AppleLossless.
a=fmtp:96 352 0 16 40 10 14 2 255 0 0 44100.
a=mfiaeskey:abcd1234efgh5678ijkl9012mnop3456.
a=aesiv:987654qwerty65432==.
a=min-latency:11025.
a=max-latency:88200.

Wed Jan 15 15:55:47 2025 [77941]
TCP  172.16.1.68:5000 --> 172.16.1.66:49340 | AP (52)
RTSP/1.0 200 OK.
Server: AirTunes/190.9.
CSeq: 3.

Wed Jan 15 15:55:47 2025 [78192]
TCP  172.16.1.66:49340 --> 172.16.1.68:5000 | AP (230)
SETUP rtsp://172.16.1.68/2009199015507279999 RTSP/1.0.
Transport: RTP/AVP/UDP;unicast;mode=record;timing_port=55965;control_port=50963.
CSeq: 4.
DACP-ID: 1234A56B7890D1E2.
Active-Remote: 9876543210.
User-Agent: AirPlay/775.3.1.

Wed Jan 15 15:55:47 2025 [98015]
TCP  172.16.1.68:5000 --> 172.16.1.66:49340 | AP (190)
RTSP/1.0 200 OK.
Transport: RTP/AVP/UDP;unicast;mode=record;server_port=1249;control_port=1251;timing_port=1247.
Session: 1.
Audio-Jack-Status: connected.
Server: AirTunes/190.9.
CSeq: 4.
----

=== Parameter Exchange (GET_PARAMETER Command)

The client queries the volume parameter via a GET_PARAMETER request. +
The server responds with the current volume value: -26.250000.

----
Wed Jan 15 15:55:47 2025 [98481]
TCP  172.16.1.66:49340 --> 172.16.1.68:5000 | AP (215)
GET_PARAMETER rtsp://172.16.1.68/2009199015507279999 RTSP/1.0.
Content-Length: 8.
Content-Type: text/parameters.
CSeq: 5.
DACP-ID: 1234A56B7890D1E2.
Active-Remote: 9876543210.
User-Agent: AirPlay/775.3.1.
.
volume.

Wed Jan 15 15:55:47 2025 [117955]
TCP  172.16.1.68:5000 --> 172.16.1.66:49340 | AP (103)
RTSP/1.0 200 OK.
Content-Type: text/parameters.
Content-Length: 20.
Server: AirTunes/190.9.
CSeq: 5.
.
volume: -26.250000.
----

=== Streaming Begins (RECORD Command)

The client sends a RECORD command to start the audio stream. +
The server acknowledges with a response, providing an Audio-Latency value of 4316 (likely in milliseconds or RTP units).

----
Wed Jan 15 15:55:47 2025 [118243]
TCP  172.16.1.66:49340 --> 172.16.1.68:5000 | AP (150)
RECORD rtsp://172.16.1.68/2009199015507279999 RTSP/1.0.
CSeq: 6.
DACP-ID: 1234A56B7890D1E2.
Active-Remote: 9876543210.
User-Agent: AirPlay/775.3.1.
.

Wed Jan 15 15:55:47 2025 [198001]
TCP  172.16.1.68:5000 --> 172.16.1.66:49340 | AP (73)
RTSP/1.0 200 OK.
Audio-Latency: 4316.
Server: AirTunes/190.9.
CSeq: 6.
.
----
